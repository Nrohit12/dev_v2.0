<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Role Permissions Tree Debugger</title>

  <!--
  ╔════════════════════════════════════════════════════════════╗
  ║  REAL-WORLD SCENARIO                                       ║
  ║                                                            ║
  ║  You are building an Admin Panel for a SaaS product.       ║
  ║  An admin is editing the "Support Agent" role to decide    ║
  ║  what this role is allowed to do.                          ║
  ║                                                            ║
  ║  PERMISSIONS (flat):                                       ║
  ║    Customer Accounts                                       ║
  ║      ├─ View Customer                                      ║
  ║      ├─ Edit Customer                                      ║
  ║      └─ Reset Password                                     ║
  ║                                                            ║
  ║    Orders                                                  ║
  ║      ├─ View Orders                                        ║
  ║      ├─ Refund Order                                       ║
  ║      └─ Cancel Order                                       ║
  ║                                                            ║
  ║    Reports                                                 ║
  ║      ├─ View Sales Report                                  ║
  ║      └─ Export CSV                                         ║
  ║                                                            ║
  ║  BEHAVIOUR:                                                ║
  ║    • If the admin checks "Customer Accounts",              ║
  ║      all its child permissions are granted.                ║
  ║    • If all children are checked, the parent auto-checks.  ║
  ║    • If some children are checked, parent is indeterminate.║
  ║                                                            ║
  ║  This is exactly the same logic you use for file trees,    ║
  ║  module toggles, feature flags, category selection, etc.   ║
  ╚════════════════════════════════════════════════════════════╝
  -->

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 24px;
      line-height: 1.4;
      background: #f5f5f7;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }

    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: #555;
    }

    .layout {
      display: flex;
      gap: 20px;
      align-items: stretch;
    }

    .panel {
      background: #ffffff;
      border-radius: 8px;
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, 0.03),
        0 12px 30px rgba(0, 0, 0, 0.06);
      padding: 14px 16px;
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #555;
    }

    .panel-section-title {
      font-size: 12px;
      font-weight: 600;
      margin: 4px 0 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #777;
    }

    .diagram {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre;
      background: #0b1020;
      color: #a5ffb3;
      border-radius: 6px;
      padding: 8px;
      overflow-x: auto;
      line-height: 1.25;
    }

    .legend {
      font-size: 11px;
      color: #666;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: #eef3ff;
      color: #3344aa;
      margin-right: 4px;
    }

    .badge.step1 { background: #e3f2fd; color: #16407b; }
    .badge.step2 { background: #e8f5e9; color: #1b5e20; }
    .badge.step3 { background: #fff8e1; color: #9c6b00; }

    /* TREE VIEW */
    #tree-container {
      margin-top: 4px;
      flex: 1;
    }

    ul.tree-list {
      list-style: none;
      margin: 0;
      padding-left: 18px;
      position: relative;
    }

    ul.tree-list::before {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: 6px;
      border-left: 1px dashed #ccc;
    }

    .tree-item {
      position: relative;
      margin: 2px 0;
      padding-left: 10px;
    }

    .tree-item::before {
      content: "";
      position: absolute;
      top: 11px;
      left: 6px;
      width: 8px;
      border-bottom: 1px dashed #ccc;
    }

    .tree-item label {
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }

    input[type="checkbox"] {
      vertical-align: middle;
    }

    .caption {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }

    .caption ul {
      padding-left: 20px;
      margin: 4px 0 0;
    }

    /* DEBUGGER PANEL */
    .debug-log {
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #020617;
      color: #e5e7eb;
      border-radius: 6px;
      padding: 6px 8px;
      max-height: 280px;
      overflow: auto;
      border: 1px solid #111827;
    }

    .debug-session-label {
      font-size: 11px;
      color: #a7f3d0;
      margin-bottom: 4px;
    }

    .log-entry {
      border-top: 1px solid rgba(148, 163, 184, 0.3);
      padding: 3px 0;
    }

    .log-entry:first-of-type {
      border-top: none;
    }

    .log-header {
      font-size: 11px;
      color: #93c5fd;
      margin-bottom: 2px;
    }

    .log-body {
      margin: 0;
      font-size: 11px;
      white-space: pre;
      color: #e5e7eb;
    }

    .clear-btn {
      align-self: flex-end;
      margin-top: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #eef2ff;
      color: #1e293b;
      cursor: pointer;
    }

    .clear-btn:hover {
      background: #e0e7ff;
    }
  </style>
</head>
<body>
  <h1>Role Permissions Tree Debugger</h1>
  <p class="subtitle">
    Real-world example: granting permissions for the <strong>"Support Agent"</strong> role in an admin panel.
  </p>

  <div class="layout">
    <!-- LEFT: diagrams + debugger -->
    <div class="panel">
      <div class="panel-title">Scenario &amp; Flow</div>

      <div class="diagram">
REAL-WORLD PROBLEM: Role Permissions

  Role: "Support Agent"
  What is this role allowed to do?

  Permission groups:

    Customer Accounts
      ├─ View Customer
      ├─ Edit Customer
      └─ Reset Password

    Orders
      ├─ View Orders
      ├─ Refund Order
      └─ Cancel Order

    Reports
      ├─ View Sales Report
      └─ Export CSV

TREE MODEL (Composite pattern):

  roots = [
    { id: 1, label: "Customer Accounts", children: [...] },
    { id: 5, label: "Orders",            children: [...] },
    { id: 9, label: "Reports",           children: [...] }
  ]

CLICK FLOW:

  [checkbox click] DOM "change" event
        │
        └─► toggleNode(nodeId, checked)
              ├─► setCheckedDown(node, checked)   (parent → children)
              ├─► updateAncestors(node)           (children → parent)
              └─► renderTree(treeRoots)           (redraw)
      </div>

      <div class="legend">
        <span class="badge step1">STEP 1</span> Build nested permission tree from flat <code>config</code><br />
        <span class="badge step2">STEP 2</span> Children → Parent auto-select / indeterminate<br />
        <span class="badge step3">STEP 3</span> Parent → Children select / unselect all
      </div>

      <div class="panel-section-title">Debugger (Click-by-click)</div>
      <div id="debug-log" class="debug-log"></div>
      <button id="clear-log-btn" class="clear-btn">Clear log</button>
    </div>

    <!-- RIGHT: interactive tree -->
    <div class="panel">
      <div class="panel-title">Role Permissions: "Support Agent"</div>
      <div id="tree-container"></div>

      <div class="caption">
        This is what an admin would see in a real app:
        <ul>
          <li>Check <strong>Customer Accounts</strong> → all child permissions are granted.</li>
          <li>Check only <strong>View Orders</strong> → <strong>Orders</strong> group becomes partially selected.</li>
          <li>Checking all children makes the parent fully checked again.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // ──────────────────────────────────────────────────────────
    // STEP 0: FLAT CONFIG (REAL-WORLD PERMISSIONS)
    // ──────────────────────────────────────────────────────────
    // Imagine this coming from the database as "permissions"
    // that you can assign to a role.
    //
    // parentId = null   → top-level permission category
    // parentId = X      → child of permission with id X
    //
    const config = [
      // Customer Accounts
      { id: 1, label: "Customer Accounts", parentId: null },
      { id: 2, label: "View Customer",     parentId: 1 },
      { id: 3, label: "Edit Customer",     parentId: 1 },
      { id: 4, label: "Reset Password",    parentId: 1 },

      // Orders
      { id: 5, label: "Orders",            parentId: null },
      { id: 6, label: "View Orders",       parentId: 5 },
      { id: 7, label: "Refund Order",      parentId: 5 },
      { id: 8, label: "Cancel Order",      parentId: 5 },

      // Reports
      { id: 9,  label: "Reports",          parentId: null },
      { id: 10, label: "View Sales Report",parentId: 9 },
      { id: 11, label: "Export CSV",       parentId: 9 }
    ];

    // ──────────────────────────────────────────────────────────
    // DEBUG UTILITIES (SNAPSHOTS + LOGGING IN UI)
    // ──────────────────────────────────────────────────────────
    let debugStep = 1;
    let debugSession = 0;

    function snapshotNode(node) {
      return {
        id: node.id,
        label: node.label,
        checked: node.checked,
        indeterminate: node.indeterminate,
        children: node.children.map(snapshotNode)
      };
    }

    function snapshotTree(roots) {
      return roots.map(snapshotNode);
    }

    function startDebugSession(nodeId, label, newChecked) {
      debugSession++;
      debugStep = 1;

      const log = document.getElementById("debug-log");
      if (!log) return;

      log.innerHTML = "";

      const sessionHeader = document.createElement("div");
      sessionHeader.className = "debug-session-label";
      sessionHeader.textContent =
        `Click #${debugSession}: "${label}" (id=${nodeId}) → checked = ${newChecked}`;
      log.appendChild(sessionHeader);
    }

    function debugLog(title, payload) {
      if (!debugSession) return;

      const log = document.getElementById("debug-log");
      if (!log) return;

      const entry = document.createElement("div");
      entry.className = "log-entry";

      const header = document.createElement("div");
      header.className = "log-header";
      header.textContent = `${debugStep++}. ${title}`;
      entry.appendChild(header);

      if (payload !== undefined) {
        const pre = document.createElement("pre");
        pre.className = "log-body";
        try {
          pre.textContent =
            typeof payload === "string"
              ? payload
              : JSON.stringify(payload, null, 2);
        } catch (e) {
          pre.textContent = String(payload);
        }
        entry.appendChild(pre);
      }

      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    // ──────────────────────────────────────────────────────────
    // STEP 1: BUILD TREE FROM FLAT CONFIG
    // ──────────────────────────────────────────────────────────
    function buildTree(items) {
      const lookup = new Map();

      // Create node objects with checkbox state
      for (const item of items) {
        lookup.set(item.id, {
          ...item,
          children: [],
          checked: false,
          indeterminate: false
        });
      }

      const roots = [];

      // Hook children to parents
      for (const item of items) {
        const node = lookup.get(item.id);

        if (item.parentId == null) {
          roots.push(node);
        } else {
          const parent = lookup.get(item.parentId);
          parent.children.push(node);
        }
      }

      return roots;
    }

    // Build parent map: childId -> parentNode
    function buildParentMap(roots) {
      const parentMap = new Map();

      function dfs(node, parent = null) {
        if (parent) {
          parentMap.set(node.id, parent);
        }
        for (const child of node.children) {
          dfs(child, node);
        }
      }

      for (const root of roots) {
        dfs(root, null);
      }

      return parentMap;
    }

    // Find node by id in tree
    function findNodeById(roots, id) {
      const stack = [...roots];

      while (stack.length) {
        const node = stack.pop();
        if (node.id === id) return node;
        stack.push(...node.children);
      }

      return null;
    }

    // ──────────────────────────────────────────────────────────
    // STEP 3: PARENT → CHILDREN (DOWNWARDS)
    // ──────────────────────────────────────────────────────────
    function setCheckedDown(node, checked) {
      node.checked = checked;
      node.indeterminate = false;

      debugLog(`setCheckedDown(nodeId=${node.id})`, snapshotNode(node));

      for (const child of node.children) {
        setCheckedDown(child, checked);
      }
    }

    // ──────────────────────────────────────────────────────────
    // STEP 2: CHILDREN → PARENT (UPWARDS)
    // ──────────────────────────────────────────────────────────
    function updateAncestors(node, parentMap) {
      const parent = parentMap.get(node.id);
      if (!parent) {
        debugLog("updateAncestors()", "Reached top-level permission – stop.");
        return;
      }

      const children = parent.children;

      debugLog(`updateAncestors(from nodeId=${node.id})`, {
        parentId: parent.id,
        parentLabel: parent.label,
        childrenBefore: children.map(snapshotNode)
      });

      const allChecked = children.every(
        (c) => c.checked && !c.indeterminate
      );
      const noneChecked = children.every(
        (c) => !c.checked && !c.indeterminate
      );

      if (allChecked) {
        parent.checked = true;
        parent.indeterminate = false;
      } else if (noneChecked) {
        parent.checked = false;
        parent.indeterminate = false;
      } else {
        parent.checked = false;
        parent.indeterminate = true;
      }

      debugLog(`parent ${parent.id} ("${parent.label}") after update`, snapshotNode(parent));

      updateAncestors(parent, parentMap);
    }

    // ──────────────────────────────────────────────────────────
    // MAIN: WHEN A CHECKBOX IS TOGGLED
    // ──────────────────────────────────────────────────────────
    function toggleNode(roots, parentMap, nodeId, newChecked) {
      const node = findNodeById(roots, nodeId);
      if (!node) return;

      debugLog("toggleNode()", {
        nodeId,
        label: node.label,
        newChecked,
        treeBefore: snapshotTree(roots)
      });

      // Parent → children
      setCheckedDown(node, newChecked);

      // Children → parent
      updateAncestors(node, parentMap);

      // Redraw UI
      renderTree(roots, parentMap);

      debugLog("toggleNode() finished", {
        treeAfter: snapshotTree(roots)
      });
    }

    // ──────────────────────────────────────────────────────────
    // RENDER: TREE DATA ► DOM
    // ──────────────────────────────────────────────────────────
    function createNodeElement(node, roots, parentMap) {
      const li = document.createElement("li");
      li.className = "tree-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = node.checked;
      checkbox.indeterminate = node.indeterminate;
      checkbox.id = `node-${node.id}`;

      checkbox.addEventListener("change", (e) => {
        const newChecked = e.target.checked;

        // Start a new debugger session for this click
        startDebugSession(node.id, node.label, newChecked);
        debugLog("DOM change event", {
          nodeId: node.id,
          label: node.label,
          newChecked
        });

        toggleNode(roots, parentMap, node.id, newChecked);
      });

      const label = document.createElement("label");
      label.htmlFor = checkbox.id;
      label.textContent = ` ${node.label}`;

      li.appendChild(checkbox);
      li.appendChild(label);

      // Recursively render children
      if (node.children.length > 0) {
        const ul = document.createElement("ul");
        ul.className = "tree-list";

        for (const child of node.children) {
          ul.appendChild(createNodeElement(child, roots, parentMap));
        }

        li.appendChild(ul);
      }

      return li;
    }

    function renderTree(roots, parentMap) {
      debugLog("renderTree()", snapshotTree(roots));

      const container = document.getElementById("tree-container");
      container.innerHTML = "";

      const ul = document.createElement("ul");
      ul.className = "tree-list";

      for (const root of roots) {
        ul.appendChild(createNodeElement(root, roots, parentMap));
      }

      container.appendChild(ul);
    }

    // ──────────────────────────────────────────────────────────
    // BOOTSTRAP
    // ──────────────────────────────────────────────────────────
    const treeRoots = buildTree(config);
    const parentMap = buildParentMap(treeRoots);

    renderTree(treeRoots, parentMap);

    // Clear-log button
    const clearButton = document.getElementById("clear-log-btn");
    if (clearButton) {
      clearButton.addEventListener("click", () => {
        const log = document.getElementById("debug-log");
        if (log) log.innerHTML = "";
        debugSession = 0;
        debugStep = 1;
      });
    }
  </script>
</body>
</html>
